<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>td {
        text-overflow: ellipsis; /* for IE */
        -moz-text-overflow: ellipsis; /* for Firefox,mozilla */
        overflow: hidden;
        white-space: nowrap;
        border: 1px solid;
        text-align: left
    }</style>
</head>
<body>
<h4>京东订单数据同步<a id="total"></a></h4>
<table class="table table-striped">
    <thead>
    <tr class="success">
        <th>订单编号</th>
        <th>下单时间</th>
        <th>付款时间</th>
        <th>下单平台</th>
        <th>总金额</th>
        <th>买家ID</th>
        <th>收货人</th>
        <th>收货地址</th>
        <th>固定电话</th>
        <th>手机</th>
        <th>开票信息</th>
        <th>发票抬头</th>
        <th>税号</th>
        <th>买家留言</th>
        <th>商家留言</th>
        <th>订单状态</th>
        <th>订单来源</th>
        <th style="width: 70px">商品数</th>
    <tr>
    </thead>
    <tbody id='orderTable'></tbody>
</table>
    <ul class="pagination">
        <li><a id="prePage" href="#">&laquo;</a></li>
        <li><a id="nextPage" href="#">&raquo;</a></li>
    </ul>
<script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript">
    console.log("load")
    var shopName="-";
    var urlGetShopName="https://api.jd.com/routerjson?v=2.0&method=jingdong.vender.shop.query&app_key=8F3A3F4A4C2C8CC7FC2B351B2F4F785E&access_token=6a47cb0d-ef17-4a64-8ca0-44128655c6b8&360buy_param_json={}&timestamp=2018-04-04 21:58:17&sign=F2A3CBC5205B7970AFD2A3B12F49A8B3";
    function getShopName() {
        console.log("getShopName");
        $.ajax({
            url: urlGetShopName,
            success: function (data) {
                shopName=JSON.parse(data).jingdong_vender_shop_query_responce.shop_jos_result.shop_name;
                getOrderPage(1,pageSize);
            }
        });
    }

    function preAndNextPageBind() {
        console.log("(进行中"+total+"单)");
        $("#total",self.parent.frames["mainFrame"].document).html("(进行中 "+total+"单)");
        $("#prePage",self.parent.frames["mainFrame"].document).unbind();
        $("#prePage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var prePage=page-1<0?1:page-1;
            console.log("prePage"+prePage);
            getOrderPage(prePage,pageSize);
        })
        $("#nextPage",self.parent.frames["mainFrame"].document).unbind();
        $("#nextPage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var nextPage=page+1>total/pageSize?total/pageSize:page+1;
            console.log("nextPage"+nextPage);
            getOrderPage(nextPage,pageSize);
        })
    }
    var page=1;
    var pageSize=10;
    var total=0;
    var urlGetOrder = 'https://api.jd.com/routerjson?v=2.0&method=jingdong.pop.order.search&app_key=8F3A3F4A4C2C8CC7FC2B351B2F4F785E&access_token=6a47cb0d-ef17-4a64-8ca0-44128655c6b8&360buy_param_json={"start_date":"","end_date":"","order_state":"WAIT_SELLER_STOCK_OUT,WAIT_GOODS_RECEIVE_CONFIRM,WAIT_SELLER_DELIVERY,PAUSE,TRADE_CANCELED,LOCKED","optional_fields":"pin,orderTotalPrice,orderState,paymentConfirmTime,orderStartTime,consigneeInfo,vatInfo,itemInfoList,invoiceInfo,orderRemark,venderRemark,orderSource","page":"'+page+'","page_size":"'+pageSize+'","sortType":"1","dateType":""}';
    function getOrderPage(thisPage,pageSize) {
        console.log("getOrderPage");
        $.ajax({
            url: urlGetOrder,
            success: function (data) {
                console.log("getOrderPage success");
                var pageReslut=JSON.parse(data).jingdong_pop_order_search_responce.searchorderinfo_result;
                var orderInfoList = pageReslut.orderInfoList;
                total=pageReslut.orderTotal;
                page=thisPage;
                preAndNextPageBind();
                $("#orderTable", self.parent.frames["mainFrame"].document).empty();
                for (var i = 0; i < orderInfoList.length; i++) {
                    var order = orderInfoList[i];
                    var row=new Object();
                    row.orderId=order.orderId;
                    row.orderStartTime=order.orderStartTime;
                    row.paymentConfirmTime=order.paymentConfirmTime;
                    //var shopName=
                    row.orderTotalPrice=order.orderTotalPrice;
                    row.pin=order.pin;
                    row.consigneeName=order.consigneeInfo.fullname;
                    row.consigneeAddress=order.consigneeInfo.fullAddress;
                    row.consigneeTelephone=order.consigneeInfo.telephone;
                    row.consigneeMobile=order.consigneeInfo.mobile;

                    row.invoiceInfo=order.invoiceInfo;
                    row.invoiceTitle=order.invoiceEasyInfo.invoiceTitle;
                    row.invoiceCode=order.invoiceEasyInfo.invoiceCode;

                    row.venderRemark=order.venderRemark;
                    row.orderRemark=order.orderRemark;
                    row.orderState=order.orderState;
                    row.orderSource=order.orderSource;


                    var itemNames='';
                    for (var j=0;j<order.itemInfoList.length;j++){
                        itemNames+=order.itemInfoList[j].skuName+",";
                    }
                    var tr="<tr><td>"
                        + row.orderId + "</td><td>"
                        + row.orderStartTime + "</td><td>"
                        + row.paymentConfirmTime + "</td><td>"
                        + shopName + "</td><td>"
                        + row.orderTotalPrice + "</td><td>"
                        + row.pin + "</td><td>"
                        + row.consigneeName + "</td><td>"
                        + row.consigneeAddress + "</td><td>"
                        + row.consigneeTelephone + "</td><td>"
                        + row.consigneeMobile + "</td><td>"
                        + row.invoiceInfo + "</td><td>"
                        + row.invoiceTitle + "</td><td>"
                        + row.invoiceCode + "</td><td>"
                        + row.venderRemark + "</td><td>"
                        + row.orderRemark + "</td><td>"
                        + row.orderState + "</td><td>"
                        + row.orderSource + "</td><td>"
                        + order.itemInfoList.length + "</td></tr>";
                    $("#orderTable", self.parent.frames["mainFrame"].document).append(tr);
                }
            }
        })
    }
    $(function () {
        getShopName();
    })
    console.log("loadOk");;
</script>
</body>
</html>
