<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>td {
        text-overflow: ellipsis; /* for IE */
        -moz-text-overflow: ellipsis; /* for Firefox,mozilla */
        overflow: hidden;
        white-space: nowrap;
        border: 1px solid;
        text-align: left
    }</style>
</head>
<body>
<h4>
    京东订单数据同步
    <span><a id="shopName"></a>
        <button id="shop1ImportBtn">同步</button>
        <a id="total"></a></span>

</h4>
<table class="table table-striped">
    <thead>
    <tr class="success">
        <th>订单编号</th>
        <th>下单时间</th>
        <th>付款时间</th>
        <th>下单平台</th>
        <th>总金额</th>
        <th>买家ID</th>
        <th>收货人</th>
        <th>收货地址</th>
        <th>固定电话</th>
        <th>手机</th>
        <th>开票信息</th>
        <th>发票抬头</th>
        <th>税号</th>
        <th>买家留言</th>
        <th>商家留言</th>
        <th>订单状态</th>
        <th>订单来源</th>
        <th style="width: 70px">-</th>
    <tr>
    </thead>
    <tbody id='orderTable'></tbody>
</table>
    <ul class="pagination">
        <li><a id="prePage" href="#">&laquo;</a></li>
        <li><a id="currentPage" href="#">1</a></li>
        <li><a id="nextPage" href="#">&raquo;</a></li>
    </ul>
<script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/izitoast/1.3.0/js/iziToast.min.js"></script>
<link href="https://cdn.bootcss.com/izitoast/1.3.0/css/iziToast.min.css" rel="stylesheet">
<!--
<script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.js"></script>
-->
<script type="text/javascript">
    function equals(s1,s2){
        return s1.indexOf(s2.trim())>=0;
    }
    //数组添方法
    Array.prototype.myfind= function(marchFun)
    {
        for (var i = 0; i < this.length; i++)
        {
            if (marchFun(this[i]))
            {
                return this[i];
            }
        }
        return null;
    };
    //随机字符串
    function randomString(len) {
        len = len || 32;
        var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
        var maxPos = $chars.length;
        var pwd = '';
        for (i = 0; i < len; i++) {
            pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
    }

    //MD5
    function md5(string) {
        function md5_RotateLeft(lValue, iShiftBits) {
            return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
        }
        function md5_AddUnsigned(lX, lY) {
            var lX4, lY4, lX8, lY8, lResult;
            lX8 = (lX & 0x80000000);
            lY8 = (lY & 0x80000000);
            lX4 = (lX & 0x40000000);
            lY4 = (lY & 0x40000000);
            lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
            if (lX4 & lY4) {
                return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
            }
            if (lX4 | lY4) {
                if (lResult & 0x40000000) {
                    return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
                } else {
                    return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
                }
            } else {
                return (lResult ^ lX8 ^ lY8);
            }
        }
        function md5_F(x, y, z) {
            return (x & y) | ((~x) & z);
        }
        function md5_G(x, y, z) {
            return (x & z) | (y & (~z));
        }
        function md5_H(x, y, z) {
            return (x ^ y ^ z);
        }
        function md5_I(x, y, z) {
            return (y ^ (x | (~z)));
        }
        function md5_FF(a, b, c, d, x, s, ac) {
            a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_F(b, c, d), x), ac));
            return md5_AddUnsigned(md5_RotateLeft(a, s), b);
        };
        function md5_GG(a, b, c, d, x, s, ac) {
            a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_G(b, c, d), x), ac));
            return md5_AddUnsigned(md5_RotateLeft(a, s), b);
        };
        function md5_HH(a, b, c, d, x, s, ac) {
            a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_H(b, c, d), x), ac));
            return md5_AddUnsigned(md5_RotateLeft(a, s), b);
        };
        function md5_II(a, b, c, d, x, s, ac) {
            a = md5_AddUnsigned(a, md5_AddUnsigned(md5_AddUnsigned(md5_I(b, c, d), x), ac));
            return md5_AddUnsigned(md5_RotateLeft(a, s), b);
        };
        function md5_ConvertToWordArray(string) {
            var lWordCount;
            var lMessageLength = string.length;
            var lNumberOfWords_temp1 = lMessageLength + 8;
            var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
            var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
            var lWordArray = Array(lNumberOfWords - 1);
            var lBytePosition = 0;
            var lByteCount = 0;
            while (lByteCount < lMessageLength) {
                lWordCount = (lByteCount - (lByteCount % 4)) / 4;
                lBytePosition = (lByteCount % 4) * 8;
                lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount) << lBytePosition));
                lByteCount++;
            }
            lWordCount = (lByteCount - (lByteCount % 4)) / 4;
            lBytePosition = (lByteCount % 4) * 8;
            lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
            lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
            lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
            return lWordArray;
        };
        function md5_WordToHex(lValue) {
            var WordToHexValue = "",
                WordToHexValue_temp = "",
                lByte, lCount;
            for (lCount = 0; lCount <= 3; lCount++) {
                lByte = (lValue >>> (lCount * 8)) & 255;
                WordToHexValue_temp = "0" + lByte.toString(16);
                WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
            }
            return WordToHexValue;
        };
        function md5_Utf8Encode(string) {
            string = string.replace(/\r\n/g, "\n");
            var utftext = "";
            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                } else if ((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                } else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
            }
            return utftext;
        };
        var x = Array();
        var k, AA, BB, CC, DD, a, b, c, d;
        var S11 = 7,
            S12 = 12,
            S13 = 17,
            S14 = 22;
        var S21 = 5,
            S22 = 9,
            S23 = 14,
            S24 = 20;
        var S31 = 4,
            S32 = 11,
            S33 = 16,
            S34 = 23;
        var S41 = 6,
            S42 = 10,
            S43 = 15,
            S44 = 21;
        string = md5_Utf8Encode(string);
        x = md5_ConvertToWordArray(string);
        a = 0x67452301;
        b = 0xEFCDAB89;
        c = 0x98BADCFE;
        d = 0x10325476;
        for (k = 0; k < x.length; k += 16) {
            AA = a;
            BB = b;
            CC = c;
            DD = d;
            a = md5_FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
            d = md5_FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
            c = md5_FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
            b = md5_FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
            a = md5_FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
            d = md5_FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
            c = md5_FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
            b = md5_FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
            a = md5_FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
            d = md5_FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
            c = md5_FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
            b = md5_FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
            a = md5_FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
            d = md5_FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
            c = md5_FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
            b = md5_FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
            a = md5_GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
            d = md5_GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
            c = md5_GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
            b = md5_GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
            a = md5_GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
            d = md5_GG(d, a, b, c, x[k + 10], S22, 0x2441453);
            c = md5_GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
            b = md5_GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
            a = md5_GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
            d = md5_GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
            c = md5_GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
            b = md5_GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
            a = md5_GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
            d = md5_GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
            c = md5_GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
            b = md5_GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
            a = md5_HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
            d = md5_HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
            c = md5_HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
            b = md5_HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
            a = md5_HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
            d = md5_HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
            c = md5_HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
            b = md5_HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
            a = md5_HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
            d = md5_HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
            c = md5_HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
            b = md5_HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
            a = md5_HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
            d = md5_HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
            c = md5_HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
            b = md5_HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
            a = md5_II(a, b, c, d, x[k + 0], S41, 0xF4292244);
            d = md5_II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
            c = md5_II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
            b = md5_II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
            a = md5_II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
            d = md5_II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
            c = md5_II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
            b = md5_II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
            a = md5_II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
            d = md5_II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
            c = md5_II(c, d, a, b, x[k + 6], S43, 0xA3014314);
            b = md5_II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
            a = md5_II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
            d = md5_II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
            c = md5_II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
            b = md5_II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
            a = md5_AddUnsigned(a, AA);
            b = md5_AddUnsigned(b, BB);
            c = md5_AddUnsigned(c, CC);
            d = md5_AddUnsigned(d, DD);
        }
        return (md5_WordToHex(a) + md5_WordToHex(b) + md5_WordToHex(c) + md5_WordToHex(d)).toLowerCase();
    }
</script>
<script type="text/javascript">

    console.log("load");
    var shopConfig={
        id:"A",
        app_key:"8F3A3F4A4C2C8CC7FC2B351B2F4F785E",
        //access_token:"6a47cb0d-ef17-4a64-8ca0-44128655c6b8"
        access_token:"5d2a449c-6de0-40c3-9649-df0c07b6aa64"
    };
    var shopName="-";
    function loadShop(thisShopConfig) {
        shopConfig=thisShopConfig;
        console.log("loadShop "+shopConfig.id);
        var urlLoadShop="https://api.jd.com/routerjson?v=2.0&method=jingdong.vender.shop.query&app_key="+shopConfig.app_key+"&access_token="+shopConfig.access_token+"&360buy_param_json={}&timestamp=2018-04-04 21:58:17&sign=F2A3CBC5205B7970AFD2A3B12F49A8B3";
        $.ajax({
            url: urlLoadShop,
            success: function (data) {
                jdResponseCheck(data);
                shopName=JSON.parse(data).jingdong_vender_shop_query_responce.shop_jos_result.shop_name;
                $("#shopName",self.parent.frames["mainFrame"].document).html(shopName);
                getOrderPage(1,pageSize);
            }
        });
    }

    function preAndNextPageBind() {
        $("#prePage",self.parent.frames["mainFrame"].document).unbind();
        $("#prePage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var prePage=currentPage-1<1?1:currentPage-1;
            console.log("prePage"+prePage);
            getOrderPage(prePage,pageSize);
        })
        $("#nextPage",self.parent.frames["mainFrame"].document).unbind();
        $("#nextPage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var nextPage=currentPage+1>parseInt(total/pageSize)+1?parseInt(total/pageSize)+1:currentPage+1;
            console.log("nextPage"+nextPage);
            getOrderPage(nextPage,pageSize);
        })
    }

    var currentPage=1;
    var pageSize=15;
    var total=0;
    function renderOrderPage(pageReslut) {
        var orderInfoList=pageReslut.orderInfoList;
        $("#orderTable", self.parent.frames["mainFrame"].document).empty();
        for (var i = 0; i < orderInfoList.length; i++) {
            var order = orderInfoList[i];
            var row=new Object();
            row.orderId=order.orderId;
            row.orderStartTime=order.orderStartTime;
            row.paymentConfirmTime=order.paymentConfirmTime;
            //var shopName=
            row.orderTotalPrice=order.orderTotalPrice;
            row.pin=order.pin;
            row.consigneeName=order.consigneeInfo.fullname;
            row.consigneeAddress=order.consigneeInfo.fullAddress;
            row.consigneeTelephone=order.consigneeInfo.telephone;
            row.consigneeMobile=order.consigneeInfo.mobile;

            row.invoiceInfo=order.invoiceInfo;
            row.invoiceTitle=order.invoiceEasyInfo.invoiceTitle;
            row.invoiceCode=order.invoiceEasyInfo.invoiceCode;

            row.venderRemark=order.venderRemark;
            row.orderRemark=order.orderRemark;
            row.orderState=order.orderState;
            row.orderSource=order.orderSource;

            var itemNames='';
            for (var j=0;j<order.itemInfoList.length;j++){
                itemNames+=order.itemInfoList[j].skuName+",";
            }
            var tr="<tr><td>"
                + row.orderId + "</td><td>"
                + row.orderStartTime + "</td><td>"
                + row.paymentConfirmTime + "</td><td>"
                + shopName + "</td><td>"
                + row.orderTotalPrice + "</td><td>"
                + row.pin + "</td><td>"
                + row.consigneeName + "</td><td>"
                + row.consigneeAddress + "</td><td>"
                + row.consigneeTelephone + "</td><td>"
                + row.consigneeMobile + "</td><td>"
                + row.invoiceInfo + "</td><td>"
                + row.invoiceTitle + "</td><td>"
                + row.invoiceCode + "</td><td>"
                + row.orderRemark + "</td><td>"
                + row.venderRemark + "</td><td>"
                + row.orderState + "</td><td>"
                + row.orderSource + "</td><td>"
                + order.itemInfoList.length + "</td></tr>";
            $("#orderTable", self.parent.frames["mainFrame"].document).append(tr);
        }
    }
    function getOrderPage(thisPage,pageSize) {
        console.log("getOrderPage");
        currentPage=thisPage;
        preAndNextPageBind();
        getOrderPageData(thisPage,pageSize,function (pageReslut) {
            $("#currentPage",self.parent.frames["mainFrame"].document).html(thisPage);
            total=pageReslut.orderTotal;
            $("#total",self.parent.frames["mainFrame"].document).html("(进行中 "+total+"单)");
            renderOrderPage(pageReslut);
        });
    }
    function getOrderPageData(page,pageSize,pageReslutHandler) {
        console.log("getOrderPageData");
        var urlGetOrder = 'https://api.jd.com/routerjson?v=2.0&method=jingdong.pop.order.search&app_key='+shopConfig.app_key+"&access_token="+shopConfig.access_token+'&360buy_param_json={"start_date":"","end_date":"","order_state":"WAIT_SELLER_STOCK_OUT,WAIT_GOODS_RECEIVE_CONFIRM,WAIT_SELLER_DELIVERY,PAUSE,TRADE_CANCELED,LOCKED","optional_fields":"pin,orderTotalPrice,orderState,paymentConfirmTime,orderStartTime,consigneeInfo,vatInfo,itemInfoList,invoiceInfo,orderRemark,venderRemark,orderSource,modified","page":"'+page+'","page_size":"'+pageSize+'","sortType":"1","dateType":""}';
        $.ajax({
            url: urlGetOrder,
            success: function (data) {
                var pageReslut=JSON.parse(data).jingdong_pop_order_search_responce.searchorderinfo_result;
                console.log("getOrderPageData success，本页数据条数："+pageReslut.orderInfoList.length);
                //var orderInfoList = pageReslut.orderInfoList;
                pageReslutHandler(pageReslut);
            }
        })
    }
    var baseUrl="http://zjtyjj.320.io";
    //注意此token失效服务器直接响应403,服务器设置了一天过期
    var apiToken="--";
    function getHeaders() {
        var token = apiToken;//登录时得到的令牌
        var key = "10086110";//API提供方设置的密钥，用以生成签名供服务器验证请求
        var timestamp = Math.round(new Date().getTime() / 1000);//时间戳
        var nonce = randomString(12);//随机数
        return {
            "Authorization": token ? ("Bearer " + token) : null,
            "timestamp": timestamp,
            "nonce": nonce,
            "sign": md5(timestamp + nonce + key)//签名
        };
    }
    //TODO 403时调用，或每次调用
    function apiCallerInit() {
        $.ajax({
            url: baseUrl+"/api/login",//接口：api/login
            type: "post",//使用post方法
            //headers: getHeaders(),
            data: {
                username: "apicaller",//用户名(必需)
                password: "10086110"//密码(必需)
            }
        }).done(function (res) {//请求完成后的处理。下文将省略此部分
            apiToken=res.token.token;
            //$.cookie("token", res.token, { expires: 30 });
        }).fail(function (jqXHR, textStatus, errMsg) {//请求失败后的处理。下文将省略此部分
            alert(errMsg);
        });
    }
    var templateDefinition={
        orderTemplateId:109,//在线订单模板表id
        orderTemplateFieldKeys:{
            "orderId":"1269",//订单编号
            "orderStartTime":"1270",//下单时间
            "paymentConfirmTime":"1271",//付款时间
            "shopName":"1272",//下单平台
            "orderTotalPrice":"1273",//订单总金额
            "pin":"1274",//买家id
            "fullname":"1275",//收货人
            "fullAddress":"1276",//收货地址
            "telephone":"1277",//手机
            "mobile":"1278",//固定电话
            "invoiceInfo":"1279",//开票信息
            "invoiceTitle":"1280",//发票抬头
            "invoiceCode":"1281",//税号
            "venderRemark":"1282",//买家留言
            "orderRemark":"1283",//商家留言
            "orderState":"1284",//订单状态
            "orderSource":"1293",//订单来源
            "modified":"1303",//京东最后修改时间
            "deliverInfoCode":"1296",//快递单号
            "1295":"物流公司",
            "1296":"快递单号",
            "1297":"快递单号变更",
            "1299":"包裹数"
        },
        convertToOrderTemplateEntity:function (order){
            var orderEntity=new Object();
            orderEntity[templateDefinition.orderTemplateFieldKeys.orderId]=order.orderId;
            orderEntity[templateDefinition.orderTemplateFieldKeys.orderStartTime]=order.orderStartTime;
            orderEntity[templateDefinition.orderTemplateFieldKeys.paymentConfirmTime]=order.paymentConfirmTime;

            orderEntity[templateDefinition.orderTemplateFieldKeys.orderTotalPrice]=order.orderTotalPrice;
            orderEntity[templateDefinition.orderTemplateFieldKeys.pin]=order.pin;
            orderEntity[templateDefinition.orderTemplateFieldKeys.modified]=order.modified;
            orderEntity[templateDefinition.orderTemplateFieldKeys.fullname]=order.consigneeInfo.fullname;
            orderEntity[templateDefinition.orderTemplateFieldKeys.fullAddress]=order.consigneeInfo.fullAddress;
            orderEntity[templateDefinition.orderTemplateFieldKeys.telephone]=order.consigneeInfo.telephone;
            orderEntity[templateDefinition.orderTemplateFieldKeys.mobile]=order.consigneeInfo.mobile;

            orderEntity[templateDefinition.orderTemplateFieldKeys.invoiceInfo]=order.invoiceInfo;
            orderEntity[templateDefinition.orderTemplateFieldKeys.invoiceTitle]=order.invoiceEasyInfo.invoiceTitle;
            orderEntity[templateDefinition.orderTemplateFieldKeys.invoiceCode]=order.invoiceEasyInfo.invoiceCode;

            orderEntity[templateDefinition.orderTemplateFieldKeys.venderRemark]=order.venderRemark;
            orderEntity[templateDefinition.orderTemplateFieldKeys.orderRemark]=order.orderRemark;
            orderEntity[templateDefinition.orderTemplateFieldKeys.orderState]=order.orderState;
            orderEntity[templateDefinition.orderTemplateFieldKeys.orderSource]=order.orderSource;
            return orderEntity;
        },
        appendDeliveryInfoToOrderTemplateEntity:function (orderEntity,orderEntityListWithDeliverInfo) {
            var orderEntityWithDeliverInfo=orderEntityListWithDeliverInfo.myfind(function (e) {
                return e[1269]=orderEntity[1269];
            });
            orderEntity[1295]=orderEntityWithDeliverInfo[1295];
            orderEntity[1296]=orderEntityWithDeliverInfo[1296];
            orderEntity[1297]=orderEntityWithDeliverInfo[1297];
            orderEntity[1299]=orderEntityWithDeliverInfo[1299];
            return orderEntity;
        }

    }
    function getOrderList(orderListHandler){
        var pageIndex=1;
        var pageSize=50;
        var orderlist=[];
        getOrderPageData(1,1,function (pageReslut) {
            var total=pageReslut.orderTotal;
            console.log("getOrderList 探测到总数："+total+",分批数"+(1+parseInt(total/pageSize)));
            for(var i=1;i<parseInt(total/pageSize)+2;i++){
                console.log("getOrderList 抓取批次："+i+"抓取size："+pageSize);
                getOrderPageData(i,pageSize,function (pageReslut) {
                    orderlist=orderlist.concat(pageReslut.orderInfoList);
                    console.log("getOrderList 抓到数据条数："+pageReslut.orderInfoList.length+"目前总数："+orderlist.length);
                    if(orderlist.length==total){
                        orderListHandler(orderlist);
                    }
                })
            }
        });
    }
    //查询JF订单 返回id等+entity
    function getOrderListFromTemplateByFilter(filter,orderListHandler) {
        console.log("getOrderListFromTemplateByFilter");
        $.ajax({
            url: baseUrl+"/api/"+templateDefinition.orderTemplateId,//接口：api/{模板ID}
            type: "get",
            headers: getHeaders(),
            data: {
                filter: filter,//过滤器名称(可选)。指定了filter，将忽略search和key参数
                page: 0,//页码(可选)。从0起计，默认值：0
                pagesize: 300//每页数量(可选)。默认值：表格视图默认版式的每页数量
            },
            success:function (result) {
                console.log("getOrderListFromTemplateByFilter success"+ result.data.length);
                var data=result.data;
                var orderEntityList=data.map(function (jfTemplateDataElement) {
                    var orderEntity=jfTemplateDataElement.fields;
                    orderEntity.id=jfTemplateDataElement.id;
                    return orderEntity;
                });
                orderListHandler(orderEntityList);
            },
            error: function(xhr,status,error){
                alert("apicaller登陆过期，已尝试自动重新登陆。请重新进行你的操作。");
                if(status==403){
                    alert("apicaller登陆过期，已尝试自动重新登陆。请重新进行你的操作。");
                    apiCallerInit();
                }else{
                    alert("JF apicall 出错");
                }
            }
        });
    }
    function saveOrderListToTemplate(orderList,success) {
        //建立数据对象。要添加多条记录，请使用对象数组：[{...}, {...}, {...}]
        //var data = {"1269":"2","1270":"2018-03-28 14:09:44","1271":"2018-04-05 14:09:46","1272":"阿三大多4","1273":"32","1274":"adsd","1275":"阿斯顿","1276":"萨达","1277":"4968489","1278":"12365","1279":"0","1280":"","1281":"","1282":"","1283":"","1284":"","1293":"","1295":"","1296":"","1297":""};
        var data=orderList;
        $.ajax({
            url: baseUrl+"/api/"+templateDefinition.orderTemplateId,//接口：api/{模板ID}
            type: "post",//使用post方法
            headers: getHeaders(),
            data: JSON.stringify(data),//将数据对象转换为字符串
            success:function () {
                success();
            }
        });
    }
    function importOrderList(){
        console.log("downloadOrderList");
        getOrderList(function (orderList) {
            console.log("getOrderList抓取京东全部未完成订单完毕,size:"+orderList.length);

            //JD订单列表转化为JF模板格式
            var orderEntityListConvertFromJDOrderList=orderList.map(function (order) {
                return templateDefinition.convertToOrderTemplateEntity(order);
            });
            //console.log("orderEntityListConvertFromJDOrderList:"+JSON.stringify(orderEntityListConvertFromJDOrderList));

            orderEntityListConvertFromJDOrderList.forEach(function (jdOrderEntity) {
                jdOrderEntity.key=templateDefinition.orderTemplateFieldKeys.orderId;
                jdOrderEntity.value=jdOrderEntity[templateDefinition.orderTemplateFieldKeys.orderId];
                jdOrderEntity.addifno=true;
            });

            // 标记已经完成的订单
            getOrderListFromTemplateByFilter("NotFinished",function (orderEntityList) {
                console.log("getOrderListFromTemplateByFilter抓取jf全部订单完毕,size: " + orderEntityList.length);
                //console.log("orderEntityList（getOrderListFromTemplateByFilter）:"+JSON.stringify(orderEntityList));
                var finishedStatusOrderIds = [];
                orderEntityList.forEach(function (jfOrderEntity) {
                    var notInJdListOrder = orderEntityListConvertFromJDOrderList.myfind(function (jdOrderEntity) {
                        return equals(jfOrderEntity[templateDefinition.orderTemplateFieldKeys.orderId], jdOrderEntity[templateDefinition.orderTemplateFieldKeys.orderId]);
                    })
                    if (null == notInJdListOrder) {
                        //jfOrderEntity[templateDefinition.orderTemplateFieldKeys.orderState] = "FINISHED_L";
                        finishedStatusOrderIds.push(jfOrderEntity[templateDefinition.orderTemplateFieldKeys.orderId]);
                    }
                });
                finishedStatusOrderIds.forEach(function (orderId) {
                    var finishedOrder={};
                    finishedOrder[templateDefinition.orderTemplateFieldKeys.orderId]=orderId;
                    finishedOrder[templateDefinition.orderTemplateFieldKeys.orderState] = "FINISHED_L";

                    finishedOrder.key=templateDefinition.orderTemplateFieldKeys.orderId;
                    finishedOrder.value=orderId;
                    orderEntityListConvertFromJDOrderList.push(finishedOrder);
                });
                console.log("需更新订单数："+orderEntityListConvertFromJDOrderList.length+" ，其中已交易完成订单数："+finishedStatusOrderIds.length)
                console.log(JSON.stringify(orderEntityListConvertFromJDOrderList))
                //批量保存jd订单（新增，按订单号选择性更新字段）
                $.ajax({
                    url: baseUrl + "/api/" + templateDefinition.orderTemplateId,//接口：api/{模板ID}
                    type: "put",//使用put方法
                    headers: getHeaders(),
                    data: JSON.stringify(orderEntityListConvertFromJDOrderList),
                    success:function (data) {
                        console.log("同步成功! "+JSON.stringify(data));
                        iziToast.show({
                            title: '同步成功!',
                            message: "更新订单数："+orderEntityListConvertFromJDOrderList.length+" ，其中已交易完成订单数："+finishedStatusOrderIds.length,
                            color:"#DD0000",
                        });
                        location.reload(true);
                    }
                });
            });
        })
    }

    var customerCode="021K35939";
    var senderName="陶双杰";
    var senderAddress="陶双杰 13122228216 上海松江区九亭镇同利路551号1栋202";
    var salePlat="0010001";
    var senderTel="13122779958";
    /**
     *  获取物流运单号
     * @param deliverInfoLogisticsId 物流公司编号
     * @param deliverInfoCodeHandler 物流公司分配的运单号处理函数
     */
    function getDeliverInfoCode(orderId,deliverInfoLogisticsId) {
        //https://api.jd.com/routerjson?v=2.0&method=jingdong.etms.waybillcode.get&app_key=8F3A3F4A4C2C8CC7FC2B351B2F4F785E&access_token=5d2a449c-6de0-40c3-9649-df0c07b6aa64&360buy_param_json={"preNum":"1","customerCode":"021K35939","orderType":"0"}&timestamp=2018-04-21 11:40:03&sign=ED35D1864B807C55752F807B1BE6D61E
        if(deliverInfoLogisticsId==2087){
            alert("只有jd快递可以获取运单号");
            return;
        }
        var url = 'https://api.jd.com/routerjson?v=2.0&method=jingdong.etms.waybillcode.get&app_key='+shopConfig.app_key+"&access_token="+shopConfig.access_token
            +'&360buy_param_json={"preNum":"1","customerCode":"'+customerCode+'","orderType":"0"}';
        var list=[];
        $.ajax({
            url: url,
            success: function (data) {
                console.log("0");
                console.log(data);
                console.log("分配的运单号是："+JSON.parse(data).jingdong_etms_waybillcode_get_responce.resultInfo.deliveryIdList[0]);
                var row = {};
                row[templateDefinition.orderTemplateFieldKeys.deliverInfoCode]=JSON.parse(data).jingdong_etms_waybillcode_get_responce.resultInfo.deliveryIdList[0];
                row.key=templateDefinition.orderTemplateFieldKeys.orderId;
                row.value=orderId;
                list.push(row);
                /*$.ajax({
                    url:baseUrl+"/api/"+templateDefinition.orderTemplateId+"/"+id,//接口：api/{模板ID}/{记录ID}
                    type: "put",//使用put方法
                    headers: getHeaders(),
                    data: JSON.stringify(row)
                });*/
                $.ajax({
                    url: baseUrl + "/api/" + templateDefinition.orderTemplateId,//接口：api/{模板ID}
                    type: "put",//使用put方法
                    headers: getHeaders(),
                    data: JSON.stringify(list),
                    success:function(){
                        location.reload(true);
                    }
                });
            }
        })
    }

    function outStrage(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount,receiveAddress,receiveName,receiveTel) {
        if(deliverInfoLogisticsId==2087){
            //jd快递接单
            innerSendDeliver(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount,receiveAddress,receiveName,receiveTel,function () {
                //出库
                console.log("innerOutStorage");
                innerOutStorage(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount);
            });
        }else{
            innerOutStorage(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount);
        }

    }

    function innerSendDeliver(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount,receiveAddress,receiveName,receiveTel,successHandler) {
        var url='https://api.jd.com/routerjson?v=2.0&method=jingdong.etms.waybill.send&app_key='+shopConfig.app_key+'&access_token='+shopConfig.access_token
            +'&360buy_param_json={"deliveryId":"'
            +deliverInfoCode+'","salePlat":"'+salePlat+'","customerCode":"'+customerCode+'","orderId":"'+orderId+'","thrOrderId":"","selfPrintWayBill":"","pickMethod":"","packageRequired":"","senderName":"'
            +senderName+'","senderAddress":"'+senderAddress+'","senderTel":"'+senderTel+'","senderMobile":"","senderPostcode":"","receiveName":"'+receiveName+'","receiveAddress":"'+receiveAddress+'","province":"","city":"","county":"","town":"","provinceId":"","cityId":"","countyId":"","townId":"","siteType":"","siteId":"","siteName":"","receiveTel":"'
            +receiveTel+'","receiveMobile":"","postcode":"","packageCount":"'+packageCount+'","weight":"1","vloumLong":"","vloumWidth":"","vloumHeight":"","vloumn":"1","description":"","collectionValue":"","collectionMoney":"","guaranteeValue":"","guaranteeValueAmount":"","signReturn":"","aging":"","transType":"","remark":"","goodsType":"","orderType":"","shopCode":"","orderSendTime":"","warehouseCode":"","areaProvId":"","areaCityId":"","shipmentStartTime":"","shipmentEndTime":"","idNumber":"","addedService":"","extendField1":"","extendField2":"","extendField3":"","extendField4":"","extendField5":"","senderCompany":"","receiveCompany":""}';

        $.ajax({
            url: url,
            success: function (data) {
                console.log("接单结果："+JSON.stringify(data));
                successHandler();
            }
        })
    }

    function innerOutStorage(orderId,deliverInfoLogisticsId,deliverInfoCode,packageCount) {
        var url = 'https://api.jd.com/routerjson?v=2.0&method=360buy.order.sop.outstorage&app_key='+shopConfig.app_key+"&access_token="+shopConfig.access_token
            +'&360buy_param_json={"logistics_id":"'+deliverInfoLogisticsId+'","waybill":"'+deliverInfoCode+'","order_id":"'+orderId+'","trade_no":""}';
        $.ajax({
            url: url,
            success: function (data) {
                console.log(JSON.stringify(data));
                alert("出库结果"+JSON.stringify(data));
                location.reload(true);
            }
        })
    }
    function importOrderListBtnBind(){
        $("#shop1ImportBtn",self.parent.frames["mainFrame"].document).bind("click",function () {
            importOrderList();
        })
    }
    //360buy.order.sopl.outstorage
    function outStorageBtnBind(){
        $("#outStorgeBtn",self.parent.frames["mainFrame"].document).bind("click",function () {
            importOrderList();
        })
    }
    $(function () {
        console.log("reday exc apiCallerInit");
        apiCallerInit();
        console.log("reday exc loadShop");
        loadShop(shopConfig);
        console.log("reday exc importOrderListBtnBind");
        importOrderListBtnBind();
    })
    function jdResponseCheck(data){
        var errorRes=JSON.parse(data).error_response;
        if(errorRes){
            console.log(JSON.stringify(errorRes));
            if(errorRes.code==19) {
                alert("授权到期，需重新获取JD店铺授权！")
                //https://oauth.jd.com/oauth/authorize?response_type=code&client_id=8F3A3F4A4C2C8CC7FC2B351B2F4F785E&redirect_uri=urn:ietf:wg:oauth:2.0:oob
                //5d2a449c-6de0-40c3-9649-df0c07b6aa64
            }
        }
    };
    console.log("loadOk");

</script>
</body>
</html>
