<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>td {
        text-overflow: ellipsis; /* for IE */
        -moz-text-overflow: ellipsis; /* for Firefox,mozilla */
        overflow: hidden;
        white-space: nowrap;
        border: 1px solid;
        text-align: left
    }</style>
</head>
<body>
<h4>
    京东订单数据同步
    <span><a id="shopName"></a><button id="shop1ImportBtn" onclick="importOrderList()">同步</button><a id="total"></a></span>

</h4>
<table class="table table-striped">
    <thead>
    <tr class="success">
        <th>订单编号</th>
        <th>下单时间</th>
        <th>付款时间</th>
        <th>下单平台</th>
        <th>总金额</th>
        <th>买家ID</th>
        <th>收货人</th>
        <th>收货地址</th>
        <th>固定电话</th>
        <th>手机</th>
        <th>开票信息</th>
        <th>发票抬头</th>
        <th>税号</th>
        <th>买家留言</th>
        <th>商家留言</th>
        <th>订单状态</th>
        <th>订单来源</th>
        <th style="width: 70px">-</th>
    <tr>
    </thead>
    <tbody id='orderTable'></tbody>
</table>
    <ul class="pagination">
        <li><a id="prePage" href="#">&laquo;</a></li>
        <li><a id="currentPage" href="#">1</a></li>
        <li><a id="nextPage" href="#">&raquo;</a></li>
    </ul>
<script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="http://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.js"></script>
<script type="text/javascript">

    console.log("load");
    var shopConfig={
        id:"A",
        app_key:"8F3A3F4A4C2C8CC7FC2B351B2F4F785E",
        access_token:"6a47cb0d-ef17-4a64-8ca0-44128655c6b8"
    };
    var shopName="-";
    function loadShop(thisShopConfig) {
        shopConfig=thisShopConfig;
        console.log("loadShop "+shopConfig.id);
        var urlLoadShop="https://api.jd.com/routerjson?v=2.0&method=jingdong.vender.shop.query&app_key="+shopConfig.app_key+"&access_token="+shopConfig.access_token+"&360buy_param_json={}&timestamp=2018-04-04 21:58:17&sign=F2A3CBC5205B7970AFD2A3B12F49A8B3";
        $.ajax({
            url: urlLoadShop,
            success: function (data) {
                jdResponseCheck(data);
                shopName=JSON.parse(data).jingdong_vender_shop_query_responce.shop_jos_result.shop_name;
                $("#shopName",self.parent.frames["mainFrame"].document).html(shopName);
                getOrderPage(1,pageSize);
            }
        });
    }

    function preAndNextPageBind() {
        $("#prePage",self.parent.frames["mainFrame"].document).unbind();
        $("#prePage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var prePage=currentPage-1<1?1:currentPage-1;
            console.log("prePage"+prePage);
            getOrderPage(prePage,pageSize);
        })
        $("#nextPage",self.parent.frames["mainFrame"].document).unbind();
        $("#nextPage",self.parent.frames["mainFrame"].document).bind("click",function () {
            var nextPage=currentPage+1>parseInt(total/pageSize)+1?parseInt(total/pageSize)+1:currentPage+1;
            console.log("nextPage"+nextPage);
            getOrderPage(nextPage,pageSize);
        })
    }

    var currentPage=1;
    var pageSize=15;
    var total=0;
    function renderOrderPage(pageReslut) {
        var orderInfoList=pageReslut.orderInfoList;
        $("#orderTable", self.parent.frames["mainFrame"].document).empty();
        for (var i = 0; i < orderInfoList.length; i++) {
            var order = orderInfoList[i];
            var row=new Object();
            row.orderId=order.orderId;
            row.orderStartTime=order.orderStartTime;
            row.paymentConfirmTime=order.paymentConfirmTime;
            //var shopName=
            row.orderTotalPrice=order.orderTotalPrice;
            row.pin=order.pin;
            row.consigneeName=order.consigneeInfo.fullname;
            row.consigneeAddress=order.consigneeInfo.fullAddress;
            row.consigneeTelephone=order.consigneeInfo.telephone;
            row.consigneeMobile=order.consigneeInfo.mobile;

            row.invoiceInfo=order.invoiceInfo;
            row.invoiceTitle=order.invoiceEasyInfo.invoiceTitle;
            row.invoiceCode=order.invoiceEasyInfo.invoiceCode;

            row.venderRemark=order.venderRemark;
            row.orderRemark=order.orderRemark;
            row.orderState=order.orderState;
            row.orderSource=order.orderSource;

            var itemNames='';
            for (var j=0;j<order.itemInfoList.length;j++){
                itemNames+=order.itemInfoList[j].skuName+",";
            }
            var tr="<tr><td>"
                + row.orderId + "</td><td>"
                + row.orderStartTime + "</td><td>"
                + row.paymentConfirmTime + "</td><td>"
                + shopName + "</td><td>"
                + row.orderTotalPrice + "</td><td>"
                + row.pin + "</td><td>"
                + row.consigneeName + "</td><td>"
                + row.consigneeAddress + "</td><td>"
                + row.consigneeTelephone + "</td><td>"
                + row.consigneeMobile + "</td><td>"
                + row.invoiceInfo + "</td><td>"
                + row.invoiceTitle + "</td><td>"
                + row.invoiceCode + "</td><td>"
                + row.orderRemark + "</td><td>"
                + row.venderRemark + "</td><td>"
                + row.orderState + "</td><td>"
                + row.orderSource + "</td><td>"
                + order.itemInfoList.length + "</td></tr>";
            $("#orderTable", self.parent.frames["mainFrame"].document).append(tr);
        }
    }
    function getOrderPage(thisPage,pageSize) {
        console.log("getOrderPage");
        currentPage=thisPage;
        preAndNextPageBind();
        getOrderPageData(thisPage,pageSize,function (pageReslut) {
            $("#currentPage",self.parent.frames["mainFrame"].document).html(thisPage);
            total=pageReslut.orderTotal;
            $("#total",self.parent.frames["mainFrame"].document).html("(进行中 "+total+"单)");
            renderOrderPage(pageReslut);
        });
    }
    function getOrderPageData(page,pageSize,pageReslutHandler) {
        console.log("getOrderPageData");
        var urlGetOrder = 'https://api.jd.com/routerjson?v=2.0&method=jingdong.pop.order.search&app_key='+shopConfig.app_key+"&access_token="+shopConfig.access_token+'&360buy_param_json={"start_date":"","end_date":"","order_state":"WAIT_SELLER_STOCK_OUT,WAIT_GOODS_RECEIVE_CONFIRM,WAIT_SELLER_DELIVERY,PAUSE,TRADE_CANCELED,LOCKED","optional_fields":"pin,orderTotalPrice,orderState,paymentConfirmTime,orderStartTime,consigneeInfo,vatInfo,itemInfoList,invoiceInfo,orderRemark,venderRemark,orderSource","page":"'+page+'","page_size":"'+pageSize+'","sortType":"1","dateType":""}';
        $.ajax({
            url: urlGetOrder,
            success: function (data) {
                var pageReslut=JSON.parse(data).jingdong_pop_order_search_responce.searchorderinfo_result;
                console.log("getOrderPageData success，本页数据条数："+pageReslut.orderInfoList.length);
                //var orderInfoList = pageReslut.orderInfoList;
                pageReslutHandler(pageReslut);
            }
        })
    }
    var baseUrl="http://zjtyjj.320.io";
    var apiToken="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJDUThLTE8wIiwiaWF0IjoxNTIyODk4NjMxLjAsImV4cCI6MTUyMjk4NTAzMC41NDM1Mzg4LCJ1c2VyIjoiYXBpY2FsbGVyIn0.5HuhVJEf6p571R9cE623MJ_37O8O0jOskml8avfTaAk";
    function randomString(len) {
        len = len || 32;
        var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
        var maxPos = $chars.length;
        var pwd = '';
        for (i = 0; i < len; i++) {
            pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
    }
    function getHeaders() {
        var token = apiToken;//登录时得到的令牌
        var key = "10086110";//API提供方设置的密钥，用以生成签名供服务器验证请求
        var timestamp = Math.round(new Date().getTime() / 1000);//时间戳
        var nonce = randomString(12);//随机数
        return {
            "Authorization": token ? ("Bearer " + token) : null,
            "timestamp": timestamp,
            "nonce": nonce,
            "sign": md5(timestamp + nonce + key)//签名
        };
    }
    function apiCallerInit() {
        if(apiToken)
        $.ajax({
            url: "http://zjtyjj.320.io/api/login",//接口：api/login
            type: "post",//使用post方法
            //headers: getHeaders(),
            data: {
                username: "apicaller",//用户名(必需)
                password: "10086110"//密码(必需)
            }
        }).done(function (res) {//请求完成后的处理。下文将省略此部分
            apiToken=res.token;
        }).fail(function (jqXHR, textStatus, errMsg) {//请求失败后的处理。下文将省略此部分
            alert(errMsg);
        });
    }

    function getOrderList(orderListHandler){
        var pageIndex=1;
        var pageSize=50;
        var orderlist=[];
        getOrderPageData(1,1,function (pageReslut) {
            var total=pageReslut.orderTotal;
            console.log("getOrderList 探测到总数："+total+",分批数"+(1+parseInt(total/pageSize)));
            for(var i=1;i<parseInt(total/pageSize)+2;i++){
                getOrderPageData(i,pageSize,function (pageReslut) {
                    orderlist=orderlist.concat(pageReslut.orderInfoList);
                    console.log("getOrderList 抓取批次："+i+",抓到数据条数："+pageReslut.orderInfoList.length+"目前总数："+orderlist.length);
                    if(orderlist.length==total){
                        orderListHandler(orderlist);
                    }
                })
            }
        });
    }
    
    function getOrderListFromDb(filter,orderListHandler) {
        console.log("getOrderListFromDb");
        $.ajax({
            url: "http://zjtyjj.320.io/api/109",//接口：api/{模板ID}
            type: "get",
            headers: getHeaders(),
            data: {
                filter: filter,//过滤器名称(可选)。指定了filter，将忽略search和key参数
                page: 0,//页码(可选)。从0起计，默认值：0
                pagesize: 1000//每页数量(可选)。默认值：表格视图默认版式的每页数量
            },
            success:function (data) {
                console.log(JSON.stringify(data))
            }
        });
    }
    function importOrderList(){
        console.log("downloadOrderList");
        getOrderList(function (orderList) {
            console.log("getOrderList抓取完毕"+orderList.length);
            getOrderListFromDb(function (orderListFromDb) {
                console.log("getOrderListFromDb抓取完毕"+orderListFromDb.length);
                var ids=[];
                var orders=[];
                for(var i=0;i<orderList.length;i++){
                    //ids.push(orderList[i].)
                }
            })
        })
        return;
        $.ajax({
            url: "http://zjtyjj.320.io/api/109",//接口：api/{模板ID}
            type: "get",
            headers: getHeaders(),
            data: {
                filter: "NotFinished",//过滤器名称(可选)。指定了filter，将忽略search和key参数
                page: 0,//页码(可选)。从0起计，默认值：0
                pagesize: 1000//每页数量(可选)。默认值：表格视图默认版式的每页数量
            }
        });

        $.ajax({
            url: "http://host/api/1",//接口：api/{模板ID}
            type: "delete",
            headers: getHeaders(),
            data: {
                ids: "1,2"//要删除的记录ID序列(必需)
            }
        });

        //建立数据对象。要添加多条记录，请使用对象数组：[{...}, {...}, {...}]
        var data = {"1269":"2","1270":"2018-03-28 14:09:44","1271":"2018-04-05 14:09:46","1272":"阿三大多4","1273":"32","1274":"adsd","1275":"阿斯顿","1276":"萨达","1277":"4968489","1278":"12365","1279":"0","1280":"","1281":"","1282":"","1283":"","1284":"","1293":"","1295":"","1296":"","1297":""};
        $.ajax({
            url: "http://host/api/4",//接口：api/{模板ID}
            type: "post",//使用post方法
            headers: getHeaders(),
            data: JSON.stringify(data)//将数据对象转换为字符串
        });

        console.log("getModelRecoder");
        $.ajax({
            url: baseUrl+"/api/109/1",//接口：api/{模板ID}/{记录ID}
            type: "get",
            headers: getHeaders(),
            success:function (data) {
                console.log("getModelRecoder success");
                console.log(JSON.stringify(data));
            }
        });
    }
    $(function () {
        loadShop(shopConfig);
        //importOrderList();
    })
    function jdResponseCheck(data){
        var errorRes=JSON.parse(data).error_response;
        if(errorRes){
            console.log(JSON.stringify(errorRes));
            if(errorRes.code==19){
                alert("授权到期，需重新获取JD店铺授权！")
            }
        }
    };
    console.log("loadOk");
</script>
</body>
</html>
